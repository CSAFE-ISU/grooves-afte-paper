---
title: "A Robust Approach to Automatically Locating Grooves in 3D Bullet Land Scans"
authors:
- affiliation: Department of Statistics, Iowa State University 
  name: Kiegan Rice
  thanks: We would like to thank the efforts of the Center for Statistics and Applications in Forensic Evidence (CSAFE) and the Roy J. Carver High Resolution Microscopy lab in scanning the Hamby set 44 and providing the scans to us. This work was partially funded by the Center for Statistics and Applications in Forensic Evidence (CSAFE) through Cooperative Agreement No. 70NANB15H176 between NIST and Iowa State University, which includes activities carried out at Carnegie Mellon University, University of California Irvine, and University of Virginia. 
- affiliation: Department of Statistics and the Center for Statistics and Applications in Forensic Evidence (CSAFE), Iowa State University 
  name: Ulrike Genschel
- affiliation: Department of Statistics and the Center for Statistics and Applications in Forensic Evidence (CSAFE), Iowa State University 
  name: Heike Hofmann
biblio-style: jfs-authoryear
output:
  pdf_document:
    citation_package: natbib
    fig_caption: yes
    keep_tex: yes
    latex_engine: pdflatex
    template: template1.tex
  html_document: default
blinded: 0
keywords:
- land engraved areas (LEAs)
- groove engraved areas (GEAs)
- 3D scans
- bullet identification 
- automatic matching
bibliography: bibliography-short.bib
nocite: | 
  @MASS
abstract: Land engraved areas (LEAs) provide evidence to address the same source-different source problem in forensic firearms examination. Advances in technology have led to new research on applying image-analysis algorithms to the automated, quantitative analysis of bullet evidence. One prominent example is an algorithm developed by Hare et. al [@Hare1] based on 3D imaging data of LEAs. Currently accepted best practice for collecting 3D images of bullet LEAs requires capturing portions of the neighboring groove engraved areas (GEAs). Analyzing LEA and GEA data separately is imperative to achieve high accuracy and precision in subsequent feature comparisons. However, existing standard statistical modeling techniques fall short when applied to the atypical structure of 3D bullet data, often failing to adequately separate LEA and GEA data. We developed a method for automated removal of GEA data based on robust locally weighted regression. This automated method was tested on high resolution 3D scans of LEAs from two bullet test sets. This separation method outperforms current methods at separating LEA and GEA data. 
---


\newcommand{\hh}[1]{{\color{orange}{#1}}}
\newcommand{\kr}[1]{{\color{teal}{#1}}}
\newcommand{\ug}[1]{{\color{purple}{#1}}}



```{r, echo = F, warning = F, message = F}
#install.packages("tidyverse")
library(tidyverse)
library(gridExtra)
library(latex2exp)
library(bulletxtrctr)
library(smoother)
```

\section{Reviewer Comments}  

Below are the reviewer comments with proposed responses. Proposed changes in accordance with reviewer comments within the text are colored teal.  

\kr{Separate out Table 1 to be for Hamby/Houston data separately. Also, update conclusions section to be correct with updated data.}

\subsection{Reviewer 1}  

1. "Currently accepted best practice..."  
    - We have rephrased in accordance with the reviewer's comment. 
2. "2D crosscuts" should be "1D profiles". 
    - Profiles are recorded in two dimensions - location and height. Traditionally in imaging, 3D topographies such as these might be considered 2.5-D, which would make profiles 1.5-D. In order to avoid discussion of dimensionality here, we choose to remove dimension entirely and refer to them as simply "crosscuts" and "profiles".  
3. Duplicate paragraph. 
    - Noted and removed. 
4. Describe rollapply, whether it is publicly available, etc. 
    - An additional paragraph describing the rollapply method and where it is available has been added to the background section. 
5. Figure 8 (boxplots).
    - We have rewritten to clarify what we are plotting. The description of Figure 8 within the text has been updated to clarify this point, as well as the figure caption. 
6. Figure 9/Table 1 are duplicated. 
    - They are in fact based on the same numbers. However, the figure gives an overview of trend while the table provides the specific quantitative information. For this reason, we believe they both provide the audience with useful insight. A sentence clarifying that they are sourced from the same information has been added. 
7. Defend choice of cutoffs for results. 
    - The binning could be done differently. What we want to see is essentially a rough categorization of different levels of deviation from the "ground truth" shoulder location. To clarify this, we have renamed the categories as "small deviation", "medium deviation", and "large deviation". 
8. X3P should be all caps
    - The ISO standard, referenced in the "Data Source" section, defines x3p as "x3p", with lowercase "x" and "p". 
9. Caliber, ammo brand, bullet material
    - We have updated the data source section to include this information.
10. Why was 0.645 chosen as the resolution? 
    - This is the resolution of our instrument at 20x magnification, so we are bound by 0.645. For reference, Hamby sets scanned at NIST and posted publicly on the NIST Ballistics and Toolmark Research Database (NBTRD) are gathered at a resolution of 1.5625 microns/pixel. Our machine's resolution is higher than that. 
11. Is rollapply only other method? Is it current-best?
    - Rollapply is the only other automated approach available in the literature for methods which perform LEA-to-LEA comparisons. 
12. Fig. 5 and 6 should be same data, or clarify if they are not. 
    - We have added information about which LEA is shown in Figures 5, 6, and 7 for clarity. 
    - Figure 5 has also been updated to be the same LEA data as Figures 5 and 6 for clarity.  
13. Why is right shoulder harder to find? 
    - We added additional details to support our hypothesis on this point.  

\subsection{Reviewer 2}  

1. Title is confusing  
    - We have updated the title for clarification. 
2. "Visual feature comparison" vs "pattern matching"
    - We use "visual feature comparison" over "pattern matching" because we want to emphasize the process of comparison, not the result. However, for clarification, we have re-worded to simply "visual comparison". 
3. "Striated tool marks"
    - Reworded to use the phrase striated tool marks instead of striations. 
4. Citation for "same source-different source problem". 
    - Added a citation.
5. Spell out LEA. Use "toolmarks produced on fired bullets". 
    - Spelled out LEA on its first appearance. 
    - Added a statement to clarify that we are referring to toolmarks on fired bullets.
6. "3rd paragraph..."
    - We are assuming you would like us to rephrase. We have done so.
7. "Impressed" should be "engraved".
    - You are correct. We have rephrased.
8. "Automated Computer Vision Techniques"
    - We were referring to automated computer vision techniques in general. However, to clarify for this specific application, we have rephrased.
9. "Data source..."
    - Yes, there are some papers that assume operators will manually trim. This is not what the Hare et. al. paper does. Rollapply is an automated approach to this in that paper.
10. "Tank rash"
    - Have rephrased.  
11. 

12. Misread of process in Fig. 7
    - Note that our process, described step-by-step on page 8, is simply to identify shoulder locations. All LEA data inside those shoulder locations are preserved and remain as part of the data included in further analysis.
    - Lines to reference where identified shoulder locations would be have been added to Figs. 6d and 7d, and clarifications have been added to the figure captions. 
13. Bullets with smooth GEA
    - This particular method is meant for sharp-edged rifling. Smooth GEAs would not cause the same structural issues as sharp-edged rifling. In downstream analysis, a LOESS fit to the bullet structure can capture the more gradual changes present with a smooth GEA and still produce a useful signature. 
14. Shoulders not aligned along longitude could cause a problem 
    - We have noted this limitation in our conclusions section. 
15. "MUST rely on operator to manually crop"
    - There is not really a comment or suggested change that we can address.
16. "Comparison of manually cropped vs. automated using CCF"
    - There are too many factors to account for to properly evaluate this within the scope of this paper. We understand that downstream analysis is the ``gold standard" but the CCF alone is not good enough to evaluate performance here. Calculating a CCF for two profiles will almost always result in a very high value due to the underlying curvature present in LEA profiles. There are multiple methods in the literature to extract a LEA signature, and they do not result in the same CCF values. To demonstrate this property, see the images below. For this reason, we believe discussing the downstream analysis would be out of scope for this paper. 
17. "Diversity in scan sets"
    - \kr{We have added an additional test set, Houston-test, to our results section. This has also been detailed in the data source section.}  
    - \kr{The figures have been updated to include the Houston-test set, but the table has not. Should the table for Hamby and Houston be kept separate?}

```{r, echo = F, warning = F}
hamby44_eval <- readRDS("data/hamby44/hamby44_eval.rda")
# Barrel 1 Bullet 1 Land 1 - 134 (Land AA)
# Barrel 1 Bullet 2 Land 5 - 129 (Land AA_2)
# Barrel 1 Bullet 1 Land 1 - 38  (Land AC)
landAA <- hamby44_eval$ccdata_w_resid[[134]] %>% 
  filter(between(x, hamby44_eval$left_groove[[134]], hamby44_eval$right_groove[[134]]))
landAA_2 <- hamby44_eval$ccdata_w_resid[[129]] %>% 
  filter(between(x, hamby44_eval$left_groove[[129]], hamby44_eval$right_groove[[129]]))
landAC <- hamby44_eval$ccdata_w_resid[[38]] %>% 
  filter(between(x, hamby44_eval$left_groove[[38]], hamby44_eval$right_groove[[38]]))

## Get CCF values for aligned profiles first
align_profs_AAs <- bulletxtrctr::sig_align(landAA$value_std, landAA_2$value_std)
#bulletxtrctr::extract_feature_ccf(align_profs_AAs$lands)
align_profs_AAAC <- bulletxtrctr::sig_align(landAA$value_std, landAC$value_std)
#bulletxtrctr::extract_feature_ccf(align_profs_AAAC$lands)

## Extract signatures the bulletxtrctr way
sigAA <- bulletxtrctr::cc_get_signature(landAA, grooves = list(groove = c(hamby44_eval$left_groove[[134]], hamby44_eval$right_groove[[134]])))
sigAA_2 <- bulletxtrctr::cc_get_signature(landAA_2, grooves = list(groove = c(hamby44_eval$left_groove[[129]], hamby44_eval$right_groove[[129]])))
sigAC <- bulletxtrctr::cc_get_signature(landAC, grooves = list(groove = c(hamby44_eval$left_groove[[38]], hamby44_eval$right_groove[[38]])))

## Align signatures and get CCF values for bulletxtrctr signatures
align_sigs_AAs <- bulletxtrctr::sig_align(sigAA$sig, sigAA_2$sig)
#bulletxtrctr::extract_feature_ccf(align_sigs_AAs$lands)
align_sigs_AAAC <- bulletxtrctr::sig_align(sigAA$sig, sigAC$sig)
#bulletxtrctr::extract_feature_ccf(align_sigs_AAAC$lands)


## Now extract signatures using a Gaussian filter
sigAA_bp <- landAA %>% mutate(structure_pass = smth.gaussian(value_std), 
                             value_pass1 = value_std - structure_pass,
                             sig_pass = smth.gaussian(value_pass1, window = 50))

sigAA_2_bp <- landAA_2 %>% mutate(structure_pass = smth.gaussian(value_std), 
                             value_pass1 = value_std - structure_pass,
                             sig_pass = smth.gaussian(value_pass1, window = 50))

sigAC_bp <- landAC %>% mutate(structure_pass = smth.gaussian(value_std), 
                             value_pass1 = value_std - structure_pass,
                             sig_pass = smth.gaussian(value_pass1, window = 50))

align_sigs_AAs_bp <- bulletxtrctr::sig_align(sigAA_bp$sig_pass, sigAA_2_bp$sig_pass)
#  bulletxtrctr::extract_feature_ccf(align_sigs_AAs_bp$lands)
align_sigs_AAAC_bp <- bulletxtrctr::sig_align(sigAA_bp$sig_pass, sigAC_bp$sig_pass)
#bulletxtrctr::extract_feature_ccf(align_sigs_AAAC_bp$lands)
```

```{r, echo = F, warning = F, message = F}
profs_AAs_plot <- align_profs_AAs$lands %>% 
  ggplot() + 
  geom_line(aes(x = x, y = sig1), color = "grey30") + 
  geom_line(aes(x = x, y = sig2), color = "grey70") + 
  theme_bw() + 
  labs(x = "Relative Location", y = "Profile Height", title  = "Profile",
  subtitle = "Maximum CCF = 0.9986")

sigs_AAs_plot <- align_sigs_AAs$lands %>% 
  ggplot() + 
  geom_line(aes(x = x, y = sig1), color = "grey30") + 
  geom_line(aes(x = x, y = sig2), color = "grey70") + 
  theme_bw() + 
  labs(x = "Relative Location", y = "Signature Height", 
       title  = "Signature Method 1", subtitle = "Maximum CCF = 0.9106")

sigs_AAs_bp_plot <- align_sigs_AAs_bp$lands %>% 
  ggplot() + 
  geom_line(aes(x = x, y = sig1), color = "grey30") + 
  geom_line(aes(x = x, y = sig2), color = "grey70") + 
  theme_bw() + 
  labs(x = "Relative Location", y = "Signature Height", 
       title  = "Signature Method 2", subtitle = "Maximum CCF = 0.9252")


grid.arrange(
  profs_AAs_plot, sigs_AAs_plot, sigs_AAs_bp_plot,
  #widths = c(8, 4, 4, 4),
  layout_matrix = rbind(c(1, 1),
                        c(1, 1),
                        c(2, 3)),
  top = "Known Match"
)

```


```{r, echo = F, warning = F, message = F}
profs_AAAC_plot <- align_profs_AAAC$lands %>% 
  ggplot() + 
  geom_line(aes(x = x, y = sig1), color = "grey30") + 
  geom_line(aes(x = x, y = sig2), color = "grey70") + 
  theme_bw() + 
  labs(x = "Relative Location", y = "Profile Height", title  = "Profile",
  subtitle = "Maximum CCF = 0.9964")

sigs_AAAC_plot <- align_sigs_AAAC$lands %>% 
  ggplot() + 
  geom_line(aes(x = x, y = sig1), color = "grey30") + 
  geom_line(aes(x = x, y = sig2), color = "grey70") + 
  theme_bw() + 
  labs(x = "Relative Location", y = "Signature Height", 
       title  = "Signature Method 1", subtitle = "Maximum CCF = 0.3913")

sigs_AAAC_bp_plot <- align_sigs_AAAC_bp$lands %>% 
  ggplot() + 
  geom_line(aes(x = x, y = sig1), color = "grey30") + 
  geom_line(aes(x = x, y = sig2), color = "grey70") + 
  theme_bw() + 
  labs(x = "Relative Location", y = "Signature Height", 
       title  = "Signature Method 2", subtitle = "Maximum CCF = 0.4171")


grid.arrange(
  profs_AAAC_plot, sigs_AAAC_plot, sigs_AAAC_bp_plot,
  #widths = c(8, 4, 4, 4),
  layout_matrix = rbind(c(1, 1),
                        c(1, 1),
                        c(2, 3)),
  top = "Known Non-Match"
)

```



\section{Background}  

Forensic firearms examiners analyze bullets through a process of \kr{visual comparison} to determine whether two bullets originate from the same source. Two bullets in question are placed under a comparison microscope and firearms examiners evaluate similarities and differences between \kr{striated toolmarks produced on fired bullets from rifled barrels. The assessment of these patterns follows} the AFTE Theory of Identification [@AFTE] guidelines resulting in a decision about whether both bullets were fired through the same gun barrel. In forensic science, this problem is known as the *same source-different source problem* \kr{[see @Ommen1]} and it focuses on establishing quantitative evidence whether two bullets were fired through the same gun barrel.  

Recent advances in technology, particularly wider access to high resolution 3D microscopy tools, have led to an increase in research on image-analysis algorithms for automated, quantitative analyses of bullet evidence. The introduction of such scanning technology to the field of forensic science allows for capture of high resolution 3D images of bullet land engraved areas (LEAs), depicted in \autoref{microscope} [see @DeKinder1; @DeKinder2; @Bachrach1].  The resulting 3D images have since been used in the development of several novel methods for automated comparison of land engraved areas [e.g. @Ma1; @Chu1; @Chu2; @Hare1]. 

```{r microscope, echo=FALSE, out.width='0.48\\textwidth', fig.cap='\\label{microscope}(Left) Close-up view of a bullet staged in a confocal light microscope. The green light marks the focal view of the capture area. (Right) Computer-rendered image of the scanned land engraved area with prominent striation marks. Breakoff is seen visually on the bottom right hand side of the scan.', fig.show='hold', fig.align='center', dev='pdf'}
knitr::include_graphics(c(
  "./images/microscope-small.png", 
  "./images/HS44-Br1-B1-L2-annotated.png"), dpi =300)
```

In this paper, we will focus only on barrels with traditional sharp-edged lands and grooves (i.e., no polygonal rifling). Sections of the bullet that make \kr{contact with high points inside the barrel are called land engraved areas (LEAs) and alternate with low points called groove engraved areas (GEAs).} Micro imperfections in the barrel introduce striae on the bullet during the firing process. The resulting striation marks provide evidence to address the same source-different source problem. A guiding principle in forensic firearms analysis is that two bullets fired through the same barrel will bear more similar striation marks on their LEAs than two bullets fired from different barrels. @Hare1 proposes a matching algorithm based on 3D imaging data of LEAs. Horizontal slices of the 3D images, called crosscuts, provide a detailed representation of striae engraved on the surface at a horizontal cross-section of each LEA. A current limitation of this algorithm is that it cannot deal with a mix of striae from both LEA and GEAs. For the human visual system, separating the two areas is straightforward. However, the same cannot be said for automated \kr{computer toolmark comparison} techniques.  

A correct identification of LEAs is vital to achieve high accuracy and precision in the subsequent downstream analysis and our goal is to present and discuss different automated methods for identifying so-called *shoulder locations*, the locations at which the land engraved areas end and the groove engraved areas begin.  

\kr{The best currently available method to identify these shoulder locations is the ``rollapply" method proposed by @Hare1. This method is publicly available through the \texttt{bulletxtrctr} package for the open source statistical computing language \texttt{R}. The authors propose first applying a rolling average to each profile to smooth out bumps in data, followed by identifying the local minima closest to the edges of each smoothed profile.}  

The structure of the paper is as follows: a description of the data storage format and data set, an explanation of methodology to predict shoulder locations, and finally an illustration of improved prediction accuracy results.  




\section{Data Source}  

All currently published automated methods rely on high resolution 3D scans of bullet land engraved areas. \kr{Our approach to the collection of}  3D images of bullet LEAs requires that bullets are staged such that striae appear vertically in the scan. Scanning across the LEA must begin and end in the neighboring groove engraved areas as shown in \autoref{fig:LEA}. Parts of the breakoff are captured as a visual reference for orientation (see \autoref{fig:microscope}).  

```{r LEA, echo=FALSE, out.width='\\textwidth', fig.cap='\\label{LEA}Visualization of 3D data collected through high resolution scanning of a land engraved area. Striations on the surface of the object can be seen by viewing this data from "above", as presented here.', fig.path = 'paper_images/LEA', dev='pdf'}
knitr::include_graphics("./images/3d_plot_top_context_breakoff.png", dpi = 300)
```


Scans are exported from the microscope as x3p files, conforming to the ISO5436-2 standard [@ISO5436]. Each scan is recorded as a matrix of prespecified $(x,y)$ locations with a measured relative height value $z$ for each $(x,y)$ location on the LEA. 

The algorithm proposed by @Hare1 uses so-called crosscuts, height measurements along $x$ for a fixed $y$. Removal of the overall curve of the bullet -- the global structure captured in the 3D scanning process -- transforms these crosscuts into to what @Hare1 refer to as *signatures* (see \autoref{fig:process}). The assessment of similarity between two LEAs is then based on a set of extracted features such as cross-correlation function, number of consecutively matching striae [see @Biasotti] and maximum number of consecutively non-matching striae. Successful extraction of this set of features depends on how well we can remove the global bullet structure to translate from a crosscut to the corresponding signature.


\begin{figure}
\begin{minipage}[b]{0.45\linewidth}
    \raggedleft
    \includegraphics[width=\textwidth]{images/3d_plot_top_crosscut}
    \centering
    Step 1: 3D scan with identified horizontal crosscut
\end{minipage}
\hspace{.5cm}
\begin{minipage}[b]{0.45\linewidth}
    \raggedright
    \includegraphics[width=\textwidth]{images/profile_paper}
    \centering
    Step 2: Horizontal crosscut with identified GEA data
\end{minipage}\\

\vspace{.3cm}
\begin{minipage}[b]{0.45\linewidth}
    \raggedleft
    \includegraphics[width=\textwidth]{images/profile_paper_loess}
    \centering
    Step 3: Non-parametric curvature estimation
\end{minipage}
\hspace{.5cm}
\begin{minipage}[b]{0.45\linewidth}
    \raggedright
    \includegraphics[width=\textwidth]{images/signature_paper}
    \centering
    Step 4: Extracted LEA signature
\end{minipage}
\caption{The process of extracting a signature from a 3D LEA scan described by \cite{Hare1}. GEA removal between Steps 2 and 3 is critical to ensure precise signature extraction.}  
\label{fig:process}
\end{figure}


In the following, we are introducing and comparing two methods for identifying shoulder locations. In order to assess the performance of these methods, we are applying both methods on 3D scans of LEAs from Hamby set 44 [@Hamby] \kr{and the Houston-test set}. Each Hamby set consists of 35 \kr{Winchester 9mm copper} bullets fired from 10 consecutively rifled Ruger P-85 \kr{9mm Luger} barrels. \kr{The Houston-test set consists of XXX bullets fired from XXX type of barrels...}  

Each fired bullet in Hamby Set 44 and Houston-test set has 6 LEAs; every LEA was scanned for each of the 35 \kr{(104)} bullets, producing data for 210 \kr{624} individual LEAs.  Two LEAs from Hamby Set 44 -- Barrel 9, Bullet 2, Land 3 and Questioned Bullet L, Land 5 -- were removed from consideration \kr{because they were deemed unsuitable for comparison. These two LEAs contained significant abrasians created by contact with the bottom of a water recovery tank after exiting the barrel. These abrasians are thus marks present on the LEAs that are not due to contact with the barrel itself}.


All 3D scans of Hamby Set 44 \kr{and Houston-test} were captured at Iowa State University's Roy J.\ Carver High Resolution Microscopy Facility with a Sensofar Confocal light microscope at 20 times magnification resulting in a resolution of 0.645 microns per pixel (1 micron = 1$\mu$m = 0.001mm). Physically, each land is approximately 2 millimeters in width; as such, data structures for a single LEA can contain more than 3 million individual data points. 



```{r prof, echo = F, warning = F, message = F, fig.height = 3.3, fig.cap = "\\label{prof}The black points show measured heights for a single crosscut of a 3D LEA scan. The main data structure, located in the center, is comprised of the land engraved area. The groove engraved areas are found on the left and right sides of the crosscut. The lines show fits of two non-parametric LOESS smooths, with and without GEA data. When GEA data is included, the smooth fails to estimate the main LEA structure near the boundaries. The LEA pictured here is Hamby 44, Barrel 10, Bullet 2, Land 2.", dpi = 300}
hamby44_eval <- readRDS("data/hamby44/hamby44_eval.rda")
bullet <- hamby44_eval$ccdata_w_resid[[48]]
bullet %>% ggplot() + 
  theme_bw() + 
  geom_rect(xmin = -50, xmax=230, ymin = -10, ymax = 130, 
            fill = rgb(0.8,0.8,0.8, 0.1)) +
  geom_rect(xmin = 2220, xmax=2500, ymin = -10, ymax = 130, 
            fill = rgb(0.8,0.8,0.8, 0.1)) +
  geom_text(x = 1175, y = 90, label= "Land\nEngraved Area", 
            colour = "grey50", size = 5, hjust = 0.5, alpha = 0.8) +
  geom_text(x = 85, y = 110, label= "Groove\nEngraved\nArea", 
            colour = "grey50", size = 3, hjust = 0.5, alpha = 0.8) +
  geom_text(x = 2350, y = 110, label= "Groove\nEngraved\nArea", 
            colour = "grey50", size = 3, hjust = 0.5, alpha = 0.8) +
  geom_point(aes(x = x, y = value_std), size = 1) + 
  labs(x = expression(paste("Relative Location x"[i], " (", mu, "m)")), 
       y =  expression(paste("Relative Height z"[i], " (", mu, "m)"))) + 
  geom_smooth(aes(x = x, y = value_std, color = "Smooth affected by GEA points"), alpha = 0.8) + 
  geom_smooth(aes(x = x, y = value_std, color = "Smooth of LEA only"), data = bullet %>% filter(between(x, 230, 2220)), alpha = 0.8) + 
  scale_colour_manual(name = "", values = c("steelblue", "darkorange")) + 
  theme(legend.position = "bottom")
  
```


Data used to assess performance of the two methods consist of crosscuts gathered from the 3D scans, as shown in \autoref{prof}. 


\section{Methodology}  


The structure in the crosscuts is dominated by the curvature of the physical object (the bullet). To assess the similarity of features from two land engraved areas, this curvature has to be removed.  

Non-parametric methods suggested in the literature, such as a LOESS fit [@Hare1] or a Gaussian filter [@Chu1] are effective for removing the curvature to extract a signature. However, they are prone to boundary effects, which cause mischaracterizations of data patterns near the boundaries of the data domain. In the case of crosscuts, the boundaries are often dominated by values originating from the GEA structure. This structure exaggerates existing boundary effects because GEAs introduce a secondary structure different from the main curvature of the LEA, as shown in \autoref{prof} and \autoref{groove-no-groove}. \autoref{prof} shows how much a non-parametric LOESS fit is affected by including GEA data. \autoref{groove-no-groove} illustrates the effect the inclusion of the same has on extracted signatures. If included, GEA data result in strong boundary effects in the signatures. Statistically, GEA data introduce outliers into the LEA data. In the next sections, we introduce two methods for fitting the LEA structure. Both methods aim to describe the relationship between horizontal position and relative height on a crosscut. While the two approaches differ in methodology, they are both rooted in the ability to mitigate potential influence caused by outlying data.  


```{r groove-no-groove, echo = F, warning = F, message = F, fig.cap = "\\label{groove-no-groove}An example of the impact failure to remove GEA data can have on an extracted signature. Even though there are only very few points in the GEA structure, the extracted signatures are dominated by boundary effects. The LEA pictured here is Hamby 44, Barrel 10, Bullet 2, Land 2.", fig.height=4, fig.width = 6, dpi = 300}
h44 <- readRDS("data/hamby44/hamby44_eval.rda")
bullet <- h44[48,]

groove <- list(groove = c(bullet$left_groove, bullet$right_groove))
bullet_sig <- bulletxtrctr::cc_get_signature(bullet$ccdata_w_resid[[1]], groove)
nogroove <- list(groove = range(bullet$ccdata_w_resid[[1]]$x))
bullet_sig_noremove <- bulletxtrctr::cc_get_signature(bullet$ccdata_w_resid[[1]], nogroove)

prof_1 <- bullet_sig %>% 
  filter(between(x, groove$groove[1], groove$groove[2])) %>%
  ggplot() + 
  geom_line(aes(x = x, y = value)) + 
  theme_bw() + 
  labs(x = expression(paste("Relative Location x"[i], " (", mu, "m)")), 
       y =  expression(paste("Relative Height z"[i], " (", mu, "m)")), 
       title = "Crosscut, groove data removed") + 
  theme(plot.title = element_text(size = 10), axis.title = element_text(size = 9))

sig_1 <- bullet_sig %>% ggplot() + 
  geom_line(aes(x = x, y = sig)) + 
  theme_bw() + 
  labs(x = expression(paste("Relative Location x"[i], " (", mu, "m)")), 
       y =  expression(paste("Signature Height", " (", mu, "m)")),
       title = "Signature, groove data removed") + 
  theme(plot.title = element_text(size = 10), axis.title = element_text(size = 9)) + 
  ylim(c(-5, 22))

prof_2 <- bullet_sig_noremove %>% ggplot() + 
  geom_line(aes(x = x, y = value)) + 
  theme_bw() + 
  labs(x = expression(paste("Relative Location x"[i], " (", mu, "m)")), 
       y =  expression(paste("Relative Height z"[i], " (", mu, "m)")),
       title = "Crosscut, groove data remains") + 
  theme(plot.title = element_text(size = 10), axis.title = element_text(size = 9))

sig_2 <- bullet_sig_noremove %>% ggplot() + 
  geom_line(aes(x = x, y = sig)) + 
  theme_bw() + 
  labs(x = expression(paste("Relative Location x"[i], " (", mu, "m)")), 
       y =  expression(paste("Signature Height", " (", mu, "m)")),
       title = "Signature, groove data remains") + 
  theme(plot.title = element_text(size = 10), axis.title = element_text(size = 9))

grid.arrange(prof_1, sig_1, prof_2, sig_2, ncol = 2)
```

In the following, we will describe the horizontal position on a crosscut of a scan as $x_i$ and measured relative height as $z_i$, where $i = 1, \dots, n$, the number of data points along a crosscut. 

\subsection{Robust Linear Models}  

A natural candidate for a curved structure is a quadratic linear model of the form 

$$
z_i = \beta_0 + \beta_1x_i + \beta_2 x_i^2 + \epsilon_i,
$$
where all error terms $\epsilon_i$ are considered independent and normally distributed with mean $0$ and variance $\sigma^2$. Parameter values of $\beta_0, \beta_1, \beta_2$ are estimated by finding the values which minimize: 

$$\arg\min_{\mathbf{\beta}} \sum_{i=1}^n \left(z_i - (\beta_0 + \beta_1x_i + \beta_2x_i^2)\right)^2,$$
the vertical squared distance between each measured height value and the fitted curve. \autoref{lms} shows that the presence of outliers near the boundaries pulls the resulting curve upwards towards groove engraved area data.  

Alternatively, the curve can be fit by minimizing the absolute deviations in place of squared deviations: 

$$\arg\min_{\mathbf{\beta}} \sum_{i=1}^n \left|z_i - (\beta_0 + \beta_1x_i + \beta_2x_i^2) \right|.$$

This method of minimization is less influenced by large outliers present in the GEA data and the resulting model is  known as a robust linear model.

Estimation based on taking squared deviations seeks to balance the fit between the LEA structure and the GEA structure, resulting in a fit which compromises between both structures without adequately fitting either. The use of absolute deviations reduces the degree of compromise in favor of fitting the majority structure, here LEA. \autoref{lms}(a) and (c) show the fitted curves from each model framework. \autoref{lms}(b) and (d) display the differences between predicted height and observed height at each location $x_i$, known as the observed model residuals $e_i$. We will utilize the observed residuals to separate the two structures. The robust model in \autoref{lms} fits the LEA structure more closely and better captures the curvature, allowing for a more accurate separation between GEA and LEA structures. 


```{r lms, echo = F, warning = F, message = F, fig.height = 4, fig.cap = "\\label{lms}Example of a quadratic linear model fit and resulting residuals (a, b) compared to a robust quadratic linear model fit and residuals (c, d) for a single profile. The robust model is able to more effectively capture the curved structure of the LEA without being influenced by the GEA. The dashed horizontal line in (d) is drawn at 4 x MAD. Values above the dashed line are considered outliers. The vertical lines in (d) are drawn where the left and right shoulder locations would be identified. The LEA pictured here is Hamby 44, Barrel 10, Bullet 2, Land 2.", dpi = 300}


#> hamby44_eval_paper$grooves_pred_mad4rlm[[48]]
#[1]  137.225 2227.345

hamby44_eval <- readRDS("data/hamby44/hamby44_eval.rda")
bullet <- hamby44_eval$ccdata_w_resid[[48]]
lm <- lm(value_std~poly(x,2), data = bullet)
bullet$lm_pred <- predict(lm, newdata = bullet)
bullet$lm_resid <- with(bullet, value_std-lm_pred)
lm0 <- MASS::rlm(value_std~poly(x,2), data=bullet, maxit=100)
bullet$rlm_pred <- predict(lm0, newdata=bullet)
#bullet$rlm_absresid <- with(bullet, abs(value_std-pred))
bullet$rlm_resid <- with(bullet, value_std-rlm_pred)

p1_rlm <- bullet %>% ggplot() + 
  geom_point(aes(x = x, y = value_std)) + 
  theme_bw() + 
  labs(x = expression(paste("Relative Location x"[i], " (", mu, "m)")), 
       y =  expression(paste("Relative Height z"[i], " (", mu, "m)")), title = "(a) Linear Model Fit") + 
  geom_line(aes(x = x, y = lm_pred), color = "red") +
  theme(axis.title.x = element_text(size = rel(1)), 
        axis.title.y = element_text(size = rel(1)), 
        axis.text.x = element_text(size = rel(1)),
        axis.text.y = element_text(size = rel(1)), 
        title = element_text(size = rel(0.7)))

p2_rlm <- bullet %>% ggplot() + 
  geom_point(aes(x = x, y = lm_resid)) + 
  theme_bw() + 
  labs(x = expression(paste("Relative Location x"[i], " (", mu, "m)")), 
       y =  expression(paste("Residual Height e"[i], " (", mu, "m)")), title = "(b) Linear Model Residuals") + 
  geom_hline(yintercept = 0, color = "red") +
  theme(axis.title.x = element_text(size = rel(1)), 
        axis.title.y = element_text(size = rel(1)), 
        axis.text.x = element_text(size = rel(1)),
        axis.text.y = element_text(size = rel(1)), 
        title = element_text(size = rel(0.7))) + 
  ylim(c(-25, 85))

p3_rlm <- bullet %>% ggplot() + 
  geom_point(aes(x = x, y = value_std)) + 
  theme_bw() + 
  labs(x = expression(paste("Relative Location x"[i], " (", mu, "m)")), 
       y =  expression(paste("Relative Height z"[i], " (", mu, "m)")), title = "(c) Robust Linear Model Fit") + 
  geom_line(aes(x = x, y = rlm_pred), color = "red") +
  theme(axis.title.x = element_text(size = rel(1)), 
        axis.title.y = element_text(size = rel(1)), 
        axis.text.x = element_text(size = rel(1)),
        axis.text.y = element_text(size = rel(1)), 
        title = element_text(size = rel(0.7)))

p4_rlm <- bullet %>% ggplot() + 
    geom_point(aes(x = x, y = rlm_resid)) + 
  theme_bw() + 
  labs(x = expression(paste("Relative Location x"[i], " (", mu, "m)")), 
       y =  expression(paste("Residual Height e"[i], " (", mu, "m)")), title = "(d) Robust Linear Model Residuals") + 
  geom_hline(yintercept = 0, color = "red") +
  theme(axis.title.x = element_text(size = rel(1)), 
        axis.title.y = element_text(size = rel(1)), 
        axis.text.x = element_text(size = rel(1)),
        axis.text.y = element_text(size = rel(1)), 
        title = element_text(size = rel(0.7))) + 
  ylim(c(-25, 85)) + 
  geom_hline(yintercept = 4*mad(bullet$rlm_resid, na.rm = T), lty = 2, color = "red") + 
  geom_vline(xintercept = c(177.225, 2227.345), color = "grey30")

library(gridExtra)
grid.arrange(p1_rlm, p2_rlm, p3_rlm, p4_rlm, ncol =2 )

```


Because the robust approach results in residual values scattered near zero in the land engraved area and larger, mostly positive residuals in the groove engraved area, we will use high residual magnitude as an indicator of GEA membership (see \autoref{lms}). High residual magnitude is determined using the median absolute deviation (MAD) of all residuals from a crosscut.

The MAD is a robust metric for the spread of data, similar to the standard deviation. It is preferable to the standard deviation to quantify the spread in situations with large outlying observations, such as the residuals in the groove engraved area.  

Let $m$ denote the median function. Then the MAD is defined as 
$$ MAD(\mathbf{e}) = m(|e_i- m(\mathbf{e})|) \quad \forall\ e_i \in \mathbf{e}.$$
Any residual value larger than $4 \times$MAD is considered an outlier and likely a member of the GEA structure.  

Shoulder location predictions are then calculated for each crosscut in the following manner (\textbf{Linear Shoulder Location Prediction}):  
\begin{enumerate}
\item Fit a robust linear model of order 2 (i.e., quadratic) to the crosscut.   
\item Calculate a residual value $e_i$ for each data point on the crosscut.  
\item Calculate the residual median absolute deviation (MAD) for the crosscut.  
\item Remove all data points on the crosscut with a residual magnitude greater than $4 \times$MAD.  
\item Identify the minimum $x_{L}$ and maximum $x_{R}$ of the remaining $x_i$ values. Then, $x_L$ and $x_R$ are the predicted left and right shoulder locations for that crosscut.   
\end{enumerate}  




\subsection{Robust LOESS}  

One of the drawbacks of the linear approach is its rigidity in the shape of the curve. Locally weighted regression, known as LOESS, is a more flexible approach. This is advantageous when working with bullets, as it is unrealistic to expect a circular shape to remain after the bullet has been subjected to the forces of a gun barrel.  

LOESS models estimate a predicted value $\widehat{z}_i$ for each height $z_i$ corresponding to location $x_i$ by estimating values $\beta_0, \beta_1$ which minimize 

\begin{equation}\label{eq:RobLOESS} \arg\min_{\mathbf{\beta}} \sum_{k=1}^n w_k(x_{i})\left(z_{k} - (\beta_0 + \beta_1x_k)\right)^2,\end{equation}

where $w_k(x_i)$ is a weight assigned to each data point $x_k$ based on its proximity to $x_i$. Weights $w_k$ decrease as the distance to $x_i$ increases, so that data points closest to $x_i$ influence the prediction $\widehat{z}_i$ most. A LOESS model can also be described as a non-parametric weighted average of many parametric models fit to subsets of the data.  

Although this approach allows for greater flexibility, LOESS models are affected more  by GEA structures than robust linear models are. Data points near and in the GEA structure are most influenced by other GEA data rather than the overall global structure. This results in a set of predictions which misrepresents much of the data near the boundaries (see \autoref{loess}).

Similar to the linear approach, there exists a robust approach to LOESS to adjust for these boundary effects. 

The robust approach to LOESS uses an iterative re-weighting process to reduce the influence of outlying data points [see @Cleveland1]. First, an initial LOESS is fit. This step is followed by a redistribution of the weights $w_k(x_i)$ based on residual values, $e_i = (z_i - \widehat{z}_i)$. New weights are calculated as 
$$\left(1-\left(\frac{e_k}{6\times MAD}\right)^2\right)^2 \times w_k(x_i) \quad \quad \mbox{if}\quad \ \left|\frac{e_k}{6\times MAD}\right| < 1,$$
else, weights are set to 0. These new weights are re-applied in (\ref{eq:RobLOESS}) and updated predictions are obtained. This reduces the influence of data points with large residual values $e_k$ in subsequent iterations. In the context of LEA crosscuts, this re-weighting reduces the influence of GEA data.

A robust LOESS model which accurately fits the LEA structure should result in a similar residual structure as that expected for the robust linear model: small residuals scattered near zero for $x_i$ locations in the land engraved area, and positive, possibly large residuals for $x_i$ locations in the groove engraved areas. The increased flexibility of LOESS models lead to a closer fit to the curvature and thus the robust LOESS more reliably results in the aforementioned residual pattern. We can thus use a lower cutoff for separation of the residuals via magnitude. A cutoff that performs well on the Hamby set 44 is twice the median absolute deviation ($2 \times MAD$).


```{r loess, echo = F, warning = F, message = F, fig.height = 4, fig.cap = "\\label{loess}Example of a LOESS model fit and residuals (a, b) compared to a robust LOESS model fit and residuals (c, d) for a single profile. The robust model is again able to more effectively capture the curved structure of the LEA without being influenced by the GEA. The dashed line in (d) represents a cutoff of 2 x MAD. Values above the dashed line are considered outliers. The vertical lines in (d) are drawn where the left and right shoulder locations would be identified. The LEA pictured here is Hamby 44, Barrel 10, Bullet 2, Land 2.", dpi = 300}
#> hamby44_eval_paper$grooves_pred_mad2[[48]]
#[1]  207.530 2227.345
lo <- loess(value_std~x, data = bullet, span = 1)
bullet$lo_pred <- predict(lo, newdata = bullet)
bullet$lo_resid <- bullet$value_std - bullet$lo_pred


p1_rlo <- bullet %>% ggplot() + 
  geom_point(aes(x = x, y = value_std)) + 
  theme_bw() + 
  labs(x = expression(paste("Relative Location x"[i], " (", mu, "m)")), 
       y =  expression(paste("Relative Height z"[i], " (", mu, "m)")), title = "(a) LOESS Fit") + 
  geom_line(aes(x = x, y = lo_pred), color = "red") +
  theme(axis.title.x = element_text(size = rel(1)), 
        axis.title.y = element_text(size = rel(1)), 
        axis.text.x = element_text(size = rel(1)),
        axis.text.y = element_text(size = rel(1)), 
        title = element_text(size = rel(0.7)))

p2_rlo <- bullet %>% ggplot() + 
  geom_point(aes(x = x, y = lo_resid)) + 
  theme_bw() + 
  labs(x = expression(paste("Relative Location x"[i], " (", mu, "m)")), 
       y =  expression(paste("Residual Height e"[i], " (", mu, "m)")), title = "(b) LOESS Residuals") + 
  geom_hline(yintercept = 0, color = "red") +
  theme(axis.title.x = element_text(size = rel(1)), 
        axis.title.y = element_text(size = rel(1)), 
        axis.text.x = element_text(size = rel(1)),
        axis.text.y = element_text(size = rel(1)), 
        title = element_text(size = rel(0.7)))


p3_rlo <- bullet %>% ggplot() + 
  geom_point(aes(x = x, y = value_std)) + 
  theme_bw() + 
  labs(x = expression(paste("Relative Location x"[i], " (", mu, "m)")), 
       y =  expression(paste("Relative Height z"[i], " (", mu, "m)")), title = "(c) Robust LOESS Fit") + 
  geom_line(aes(x = x, y = rlo_pred), color = "red") +
  theme(axis.title.x = element_text(size = rel(1)), 
        axis.title.y = element_text(size = rel(1)), 
        axis.text.x = element_text(size = rel(1)),
        axis.text.y = element_text(size = rel(1)), 
        title = element_text(size = rel(0.7)))


p4_rlo <- bullet %>% ggplot() + 
    geom_point(aes(x = x, y = rlo_resid)) + 
  theme_bw() + 
  labs(x = expression(paste("Relative Location x"[i], " (", mu, "m)")), 
       y =  expression(paste("Residual Height e"[i], " (", mu, "m)")), title = "(d) Robust LOESS Residuals") + 
  geom_hline(yintercept = 0, color = "red") +
  theme(axis.title.x = element_text(size = rel(1)), 
        axis.title.y = element_text(size = rel(1)), 
        axis.text.x = element_text(size = rel(1)),
        axis.text.y = element_text(size = rel(1)), 
        title = element_text(size = rel(0.7))) + 
  geom_hline(yintercept = 2*mad(bullet$rlm_resid, na.rm = T), lty = 2, color = "red") + 
  geom_vline(xintercept = c(207.530, 2227.345), color = "grey30")


#library(gridExtra)
grid.arrange(p1_rlo, p2_rlo, p3_rlo, p4_rlo, ncol =2 )
```


Shoulder location predictions are calculated for each crosscut in the following manner (\textbf{LOESS shoulder location prediction}): 
\begin{enumerate}
\item Fit a robust LOESS model to the crosscut \citep{locfit}.
\item Calculate a residual value $e_i$ for each data point on the crosscut.  
\item Calculate the residual median absolute deviation (MAD) for the crosscut.  
\item Remove all data points on the crosscut with a residual magnitude greater than $2 \times$MAD.  
\item Identify the minimum $x_{L'}$ and maximum $x_{R'}$ of the remaining $x_i$ values. Then, $x_{L'}$ and $x_{R'}$ are the predicted left and right shoulder locations for that crosscut.   
\end{enumerate}




\section{Results}  

To quantitatively assess the predictive ability of the two alternative models, we first  identified "ground truth" of shoulder locations by visual inspection for each of the 208 crosscuts in Hamby set 44 \kr{and each of the 414 crosscuts in Houston-test}.


As a performance measure, we define the error as the "area of misidentification", i.e., the area of each crosscut which is identified incorrectly by the method. This metric is calculated for the left shoulder location as:  

$$ \widehat{A}_{jL} = \sum_{e_{ij} \in \widetilde{X}_{jL}} \left|e_{ij} \right| \times \left(x_{i+1} - x_i \right),$$
where $\widetilde{X}_{jL}$ is the set of points in crosscut $j$ that fall between the predicted and actual left shoulder location, $e_{ij}$ corresponds to the residual value at location $x_i$ from the robust LOESS fit to crosscut $j$, and $(x_{i+1} - x_i)$ is the distance between two subsequent locations in the crosscut. For the scans of Hamby set 44 \kr{and Houston-test}, this distance is equal to $0.645 \mu m$ for all locations.  

Similarly, the area is calculated for the right shoulder location as: 

$$ \widehat{A}_{jR} = \sum_{e_{ij} \in \widetilde{X}_{jR}} \left|e_{ij} \right| \times \left(x_{i+1} - x_i \right),$$
where $\widetilde{X}_{jR}$ is the set of points in crosscut $j$ that fall between the predicted and actual right shoulder location. 

Both the left and right areas of misindentification are thus in terms of microns and represent the area of loss we incur from incorrectly identifying a shoulder location.  

Quantifying the results as an area is preferable to a distance metric as it captures not only the width of the profile area that is misidentified, but also the relative heights of the data. Larger misidentified areas indicate larger portions of the GEA remain included in a profile, and thus signal an area which is more likely to have influence on an extracted signature. Smaller areas of misidentification suggest minimal loss is incurred, and these areas will have minimal effect on an extracted signature.  

An area of misidentification was calculated separately for the left hand side and right hand side predictions for each of the 208 \kr{+414} profiles in the data set, where predictions were based on the Robust Linear Model and Robust LOESS methods, as well as the Rollapply method suggested in @Hare1.  

<!-- \kr{How is the section above now? Would replace everything below until XXX.}   -->

<!-- The numerical comparison of predicted and manually identified locations can be tricky; distance metrics alone do not suffice to represent the true character of a prediction's accuracy. For example, a predicted shoulder location that falls 10 data points away from the manually identified shoulder location could be caused by noise in the data, missing data points, or simply the scale of the data. Note that a span of 10 data points represents only 6.45 microns in physical space. Alternatively, a distance of 10 points could indeed be part of the groove engraved area, and thus being incorrectly identified could potentially cause problems in subsequent analyses.   -->

<!-- A more suitable measure is to investigate the residual values resulting from the robust LOESS model that fall in the range spanned by the predicted and manually identified shoulder location. This method penalizes shoulder location predictions that are too far out to the side and leave GEA data in the main structure.  -->

<!-- Because the robust LOESS most reliably approximates the curved shape of the bullet land due to its flexibility, we want to use residual values resulting from that model to assess final performance of all methods. Residual values from the GEA will not necessarily be uniformly large, but are expected to be positive as their structure and the modeling technique dictate that they would fall above the fitted line from robust LOESS.  -->

<!-- With positive residuals in the GEA, even a 10-point difference can quickly add to a large residual sum. However, a 10-point difference within the land engraved area will be balanced out by the presence of both positive and negative residual values and remain closer to zero.   -->

<!-- For this reason, gathering the sum of residuals between the predicted location and the manually identified location is appropriate. This residual sum is referred to as an "inaccuracy score" for which higher values indicate a higher level of inaccuracy. An inaccuracy score was calculated separately for the left hand side and right hand side predictions for each profile in the data set. This was calculated for the Robust Linear Model and Robust LOESS methods, as well as the Rollapply method suggested in @Hare1.   -->

<!-- \hh{XXX} -->

To assess the performance of all three methods, we consider the distribution of the areas of misidentification across all 208 \kr{+414} lands of Hamby set 44 \kr{and Houston-test}. \kr{\autoref{results1} presents each distribution as a boxplot. The box encompasses the middle 50\% of values, spanning the 25th to 75th percentile. The line inside each box represents the median value, and individual data points are unusually large values we call outliers.} A distribution starting at or close to zero with minimal spread is ideal as this suggests many of the predicted shoulder locations are very close to the manually identified locations, and predictions are removing many of the outlying GEA points. A distribution with a wider spread or many high, outlying areas of misidentification suggests a greater degree of uncertainty and inaccuracy for a particular method. \kr{Some of the outliers are so extreme, statistics appear very close to one another or on top of each other.}  

```{r results1, echo = F, warning = F, message = F, fig.height = 6, fig.width = 6, fig.cap = "\\label{results1}Distribution, presented here as a boxplot, of areas of misidentification for rollapply (data smoothing) method, robust linear model method, and robust LOESS method, separated by left and right shoulder locations. A dense distribution with few high values indicates good performance across the LEAs in the data set.", dpi = 300}
hamby44_eval_paper <- readRDS("data/hamby44/hamby44_eval_paper.rda")
houston <- readRDS("data/houston_eval.rda")
#phoenix <- readRDS("data/phoenix_eval.rda")
hamby44_eval_paper <- hamby44_eval_paper %>% ungroup() %>% select(source, crosscuts, score_left_rollapply, score_right_rollapply, score_left_mad2:score_right_mad4rlm)
  dataset <- full_join(hamby44_eval_paper, houston)
  #dataset <- hamby44_eval_paper
  methods <- c("rollapply", "mad2", "mad4rlm")
  colnames <- c()
  for (i in 1:length(methods)){
    colnames <- c(colnames, paste0("score_left_", methods[i]))
    colnames <- c(colnames, paste0("score_right_", methods[i]))
  }
  plot_df <- dataset %>% ungroup() %>% 
    select(colnames) %>%  
    gather(method, score) %>% 
    mutate(GrooveMethod = unlist(purrr::map(method, .f = function(x){
      strsplit(x, "_")[[1]][3]
        })), GrooveSide = unlist(purrr::map(method, .f = function(x){
      strsplit(x, "_")[[1]][2]
        }))
    ) 
  plot_df$GrooveLabels <- ifelse(plot_df$GrooveSide=="left", "left shoulder location", "right shoulder location")
  plot_1 <- plot_df %>% 
    ggplot() + geom_boxplot(aes(x = GrooveMethod, y = abs(score)*0.645), fill = "grey80") + 
      theme_bw() + labs(x = "Groove Side", y = "Area of Misidentification", title = "Full Distribution") + 
    facet_wrap(~GrooveLabels ) + 
    #scale_fill_manual(name="Method", values=c("#E69F00", "#56B4E9","#009E73"),
    #                     breaks=c("rollapply", "mad4rlm", "mad2"),
    #                     labels=c("Rollapply", "Robust Linear Model", "Robust LOESS")) + 
    scale_x_discrete(name = "", breaks = c("rollapply", "mad4rlm", "mad2"), 
                     labels = c("Rollapply", "Robust Linear Model", "Robust LOESS"), 
                     limits=c("rollapply","mad4rlm","mad2")) + 
    theme(axis.text.x = element_text(angle =10))
  plot_zoom <- plot_df %>% filter(score < 5000) %>% 
    ggplot() + geom_boxplot(aes(x = GrooveMethod, y = abs(score)*0.645), fill = "grey80") + 
      theme_bw() + labs(x = "Groove Side", y = "Area of Misidentification", title = "Truncated at 5000") + 
    facet_wrap(~GrooveLabels ) + 
    #scale_fill_manual(name="Method", values=c("#E69F00", "#56B4E9","#009E73"),
    #                     breaks=c("rollapply", "mad4rlm", "mad2"),
    #                     labels=c("Rollapply", "Robust Linear Model", "Robust LOESS")) + 
        scale_x_discrete(name = "", breaks = c("rollapply", "mad4rlm", "mad2"), 
                         labels = c("Rollapply", "Robust Linear Model", "Robust LOESS"),
                         limits=c("rollapply","mad4rlm","mad2")) + 
    theme(axis.text.x = element_text(angle =10))
  library(gridExtra)
  grid.arrange(plot_1, plot_zoom)

```

Because the raw distributions are difficult to visually compare due to extreme outliers, we categorized areas of misidentification as \kr{small, medium, and large deviations. Scores under 100 are considered small deviations, scores between 100 and 1000 are medium, and scores above 1000 are considered large deviations (see \autoref{results2}). Cases with large deviations are the most likely to cause poor or flawed results in subsequent analyses.} Note that \autoref{results2} and \autoref{results-table} are based on the same numbers but provide two different presentations of the results.  

It is important to note that different results are expected for the left and right shoulder locations. Within Hamby set 44, almost all scans have a well-defined left groove. Left here is defined as visually left on the scan; this is the side the scan begins on, so a well-defined distinction between GEA and LEA is expected. Often, a less clear distinction is seen on the right side of the scan, with sometimes no apparent shoulder location visible. \kr{This may be due to the left shoulder corresponding to the leading edge in the twist of a bullet as it is propelled through a gun barrel.} For this reason it is preferable to separate the left and right for visual inspection of results; a method may excel on one side but fall short on another.   




```{r results2, echo = F, warning = F, message = F, fig.height = 4, fig.cap = "\\label{results2}Distribution of areas of misidentification for rollapply (data smoothing) method, robust linear model method, and robust LOESS method, separated by left and right shoulder locations. Areas of misidentification are placed into three categories: less than 100 microns (small deviations), between 100 and 1000 microns, and greater than 1000 microns. A larger proportion of areas of misidentification under 100 microns indicates good performance across LEAs in the data set. Results are split between Hamby set 44 and the  Houston-test set.", dpi = 300}
#phoenix <- readRDS("data/phoenix_eval.rda")
#hamby44_eval_paper <- hamby44_eval_paper %>% ungroup() %>% select(source, crosscuts, score_left_rollapply, score_right_rollapply, score_left_mad2:score_right_mad4rlm)
  hamby44_eval_paper$testset <- "hamby"
  houston$testset <- "houston"
  dataset <- full_join(hamby44_eval_paper, houston)
#dataset <- hamby44_eval_paper
  methods <- c("rollapply", "mad2", "mad4rlm")
  colnames <- c()
  for (i in 1:length(methods)){
    colnames <- c(colnames, paste0("score_left_", methods[i]))
    colnames <- c(colnames, paste0("score_right_", methods[i]))
  }
  plot_df <- dataset %>% ungroup() %>% 
    select(colnames, testset) %>%  
    gather(method, score, -testset) %>% 
    mutate(GrooveMethod = unlist(purrr::map(method, .f = function(x){
      strsplit(x, "_")[[1]][3]
        })), GrooveSide = unlist(purrr::map(method, .f = function(x){
      strsplit(x, "_")[[1]][2]
        }))
    ) %>% 
    mutate(score = score*0.645) %>%
    mutate(AccuracyCategory = ifelse(abs(score) < 100, "<100", "100, 1000")) %>% 
    mutate(AccuracyCategory = ifelse(abs(score) >= 1000, ">1000", AccuracyCategory))
  
  plot_df$GrooveLabels <- ifelse(plot_df$GrooveSide=="left", "left shoulder location", "right shoulder location")
  plot_cat_1 <- plot_df %>% 
    filter(testset == "hamby") %>%
    ggplot() + geom_bar(aes(x = GrooveMethod, fill=factor(AccuracyCategory, levels=c(">1000","100, 1000", "<100"))), position = "stack") + 
      theme_bw() + labs(x = "Groove Method", y = "Number of LEAs", title = "Hamby set 44") + 
    facet_wrap(~GrooveLabels ) + 
    scale_fill_manual(name="Area of Misidentification", values=c("black", "grey50", "grey80"), #values=c("#E69F00", "#56B4E9", "#009E73"),
                         breaks=c(">1000", "100, 1000", "<100"),
                         labels=c("Greater than 1000", "Between 100 and 1000", "Less than 100")) + 
    scale_x_discrete(name = "Method", breaks = c("rollapply", "mad4rlm", "mad2"), 
                     labels = c("Rollapply", "Robust Linear Model", "Robust LOESS"), 
                     limits=c("rollapply","mad4rlm","mad2")) + 
    theme(axis.text.x = element_text(angle =10, size = 8))
  
  plot_cat_2 <- plot_df %>% 
    filter(testset == "houston") %>%
    ggplot() + geom_bar(aes(x = GrooveMethod, fill=factor(AccuracyCategory, levels=c(">1000","100, 1000", "<100"))), position = "stack") + 
      theme_bw() + labs(x = "Groove Method", y = "Number of LEAs", title = "Houston test set") + 
    facet_wrap(~GrooveLabels ) + 
    scale_fill_manual(name="Area of Misidentification", values=c("black", "grey50", "grey80"), #values=c("#E69F00", "#56B4E9", "#009E73"),
                         breaks=c(">1000", "100, 1000", "<100"),
                         labels=c("Greater than 1000", "Between 100 and 1000", "Less than 100")) + 
    scale_x_discrete(name = "Method", breaks = c("rollapply", "mad4rlm", "mad2"), 
                     labels = c("Rollapply", "Robust Linear Model", "Robust LOESS"), 
                     limits=c("rollapply","mad4rlm","mad2")) + 
    theme(axis.text.x = element_text(angle =10, size = 8))
  
  grid.arrange(plot_cat_1, plot_cat_2)
  
```


\begin{table}[]
\centering
\begin{tabular}{lrrr|rrr}
& \multicolumn{3}{c}{\textbf{Left Shoulder Location}} & \multicolumn{3}{c}{\textbf{Right Shoulder Location}} \\
\textbf{Method} & $(0,100)$ & $ (100, 1000) $ & $(1000, \infty)$ & $(0,100)$ & $ (100, 1000) $ & $(1000, \infty)$ \\ \hline
Rollapply & `r round((235/622)*100, 2)` & 8.20 & `r round((336/622)*100, 2)` & `r round((276/622)*100, 2)`& `r round((202/622)*100, 2)`&`r round((144/622)*100, 2)`  \\ \hline
Robust Linear Model & 28.30 & `r round((49/622)*100, 2)` & `r round((397/622)*100, 2)` & `r round((201/622)*100, 2)` & `r round((151/622)*100, 2)`&`r round((270/622)*100, 2)` \\ \hline
Robust LOESS & `r round((454/622)*100, 2)` & `r round((47/622)*100, 2)` & `r round((121/622)*100, 2)` & `r round((386/622)*100, 2)`& `r round((148/622)*100, 2)`&`r round((88/622)*100, 2)`\\ \hline
\end{tabular}
\caption{Table of results for areas of misidentification (in $\mu m^2$) resulting from automated shoulder location identification methods applied to Hamby set 44 and Houston-test. Results are presented as percentage of shoulder location predictions which fall into each category: small deviations (less than 100), medium deviations (between 100 and 1000), and large deviations (greater than 1000).}
\label{results-table}
\end{table}



\section{Conclusions}  

\kr{Need to update this description because Robust Linear does worse for Houston-test...} Both the robust linear model and robust LOESS approaches outperform currently implemented solutions based on data smoothers for the right shoulder location. Of the two, the robust LOESS approach clearly outperforms the robust linear model. This hierarchy of performance is well within expectation given the strength of robust approaches in general as well as the flexibility of LOESS applied to this data type. Robust LOESS also readily handles variation introduced in the process of translating the physical bullet into a 3D object. If there is too much variability in how the bullet is placed relative to the plane of reference on the microscope, profiles can have tilted shapes relative to the x-axis which a quadratic linear model would fail to address. In these situations, LOESS excels.  

While the proposed cutoff values as multiples of MAD work well on Hamby set 44 \kr{and Houston-test}, additional validation will need to be executed on a wider variety of barrel types. Depth of striae, physical size of bullet due to caliber, and non-traditional rifling techniques may require alterations to this cutoff value. \kr{LEAs with shoulders which are not aligned horizontally due to tild may also require slight alterations to the method.} In addition, a study of the effect of implementing robust LOESS shoulder location identification on the downstream similarity assessment will need to be completed. Due to increased accuracy of predicted shoulder locations, the authors expect an increase in accuracy in bullet matching algorithms. However, this will need to be validated on a variety of data sets prior to implementation without human intervention in the automated process.   



```{r,echo = F}
    #pandoc_args: [
    #  "-V", "classoption=twocolumn"
    #]
```



